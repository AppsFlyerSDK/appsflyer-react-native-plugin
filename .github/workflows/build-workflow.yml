name: Build React-Native and Expo apps with AppsFlyer plugin
#                                          /--> rn --> build android
#                                         /---> rn --> build ios
# --> Install plugin on rn and expo apps 
#                                        \---> expo --> build android
#                                         \--> expo --> build ios

on:
  push:
    branches:
      - 'releases/*/*/*'
  pull_request:
    branches:
      - master

jobs:
  Build-Expo-android:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: ğŸš€  Install AppsFlyer on an Expo-Android
      run: | 
        cd demos/appsflyer-expo-app
        yarn install
        yarn add expo
        yarn add ../../ --save
    - name: ğŸ©  Install expo cli
      run: npm install --global expo-cli
    - name: ğŸ“¦  Generate native folders
      run: |
        cd demos/appsflyer-expo-app
        expo prebuild
    - name: ğŸ› ï¸  Build apk
      run: |
        cd demos/appsflyer-expo-app/android
        chmod +x ./gradlew
        ./gradlew assembleRelease

  Build-RN-android:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: ğŸš€  Install AppsFlyer on a RN-Android
      run: |
        cd demos/appsflyer-react-native-app
        yarn install
        yarn add ../../ --save
    - name: ğŸ› ï¸  Build apk
      run: |
        cd demos/appsflyer-react-native-app/android
        chmod +x ./gradlew
        ./gradlew assembleRelease

  Build-Expo-iOS:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v3
    - name: ğŸš€  Install AppsFlyer on an Expo-iOS
      run: | 
        cd demos/appsflyer-expo-app
        yarn install --force
        yarn add ../../ --save
    - name: ğŸ©  Install expo cli
      run: npm install --global expo-cli
    - name: ğŸ“¦  Generate native folders
      run: |
        cd demos/appsflyer-expo-app
        expo prebuild

  Build-RN-ios:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v3
    - name: ğŸš€  Install AppsFlyer on a RN-iOS
      run: | 
        cd demos/appsflyer-react-native-app
        yarn install --force
        yarn add ../../ --save
    - name: ğŸ“¥  Install Dependencies
      run: |
        cd demos/appsflyer-react-native-app/ios
        pod install --repo-update
    - name: ğŸ› ï¸  Build .app
      run: echo 'We need to figure out how to build ios... =\'
     # run: xcodebuild -workspace demos/appsflyer-react-native-app/ios/AppsFlyerExample.xcworkspace -scheme AppsFlyerExample clean archive -allowProvisioningUpdates

  Deploy-To-QA:
    if: github.ref == 'releases/*/*/*'
    needs: [Build-RN-ios, Build-RN-ios, Build-RN-android, Build-Expo-android]
    runs-on: macos-latest
    steps:
    - uses: ./.github/workflows/deploy.yml