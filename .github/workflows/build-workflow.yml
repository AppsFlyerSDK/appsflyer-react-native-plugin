name: Build React-Native and Expo apps with AppsFlyer plugin
#                                          /--> rn --> build android
#                                         /---> rn --> build ios
# --> Install plugin on rn and expo apps 
#                                        \---> expo --> build android
#                                         \--> expo --> build ios
on: [pull_request, push]

jobs:
  Build-Expo-android:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: 🚀  Install AppsFlyer on an Expo-Android
      run: | 
        cd demos/appsflyer-expo-app
        yarn install
        yarn add expo
        yarn add ../../ --save
    - name: 🎩  Install expo cli
      run: npm install --global expo-cli
    - name: 📦  Generate native folders
      run: |
        cd demos/appsflyer-expo-app
        expo prebuild
    - name: 🛠️  Build apk
      run: |
        cd demos/appsflyer-expo-app/android
        chmod +x ./gradlew
        ./gradlew assembleRelease

  Build-RN-android:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: 🚀  Install AppsFlyer on a RN-Android
      run: |
        cd demos/appsflyer-react-native-app
        yarn install
        yarn add ../../ --save
    - name: 🛠️  Build apk
      run: |
        cd demos/appsflyer-react-native-app/android
        chmod +x ./gradlew
        ./gradlew assembleRelease

  Build-Expo-iOS:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: 🚀  Install AppsFlyer on an Expo-iOS
      run: | 
        cd demos/appsflyer-expo-app
        yarn install --force
        yarn add ../../ --save
    - name: 🎩  Install expo cli
      run: npm install --global expo-cli
    - name: 📦  Generate native folders
      run: |
        cd demos/appsflyer-expo-app
        expo prebuild

  Build-RN-ios:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v3
    - name: 🚀  Install AppsFlyer on a RN-iOS
      run: | 
        cd demos/appsflyer-react-native-app
        yarn install --force
        yarn add ../../ --save
    - name: 📥  Install Dependencies
      run: |
        cd demos/appsflyer-react-native-app/ios
        pod install --repo-update
    - name: 🛠️  Build .app
      run: xcodebuild -workspace demos/appsflyer-react-native-app/ios/AppsFlyerExample.xcworkspace -scheme AppsFlyerExample clean archive -allowProvisioningUpdates
     # uses: sersoft-gmbh/xcodebuild-action@v1
     # with:
      #  project: demos/appsflyer-react-native-app/ios/AppsFlyerExample.xcodeproj
      #  scheme: AppsFlyerExample
      #  action: build